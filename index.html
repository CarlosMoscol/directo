<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Racha Navide√±a</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"/>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>


    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 12px; background:#f6f8fb; color:#222; }
        header { background-color:#1721BF; padding:12px 0; text-align:center; color:#fff; font-family:'DIN', 'DIN Alternate', sans-serif; }
        header h1 { margin:0; font-size:20px; font-weight:700; line-height:1.2em; }
        .controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:12px 0; }
        .controls select, .controls input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid #d0d7de; font-size:14px; min-width:140px; }
        .controls .search-box { min-width:200px; max-width:320px; width:40vw; }
        .table-wrapper { background:#fff; border-radius:10px; padding:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow-x:auto; margin-bottom:20px; }
        table.dataTable.no-footer { border-bottom: none; }
        table.dataTable tbody tr:hover { background:#f1f5fb; }
        .diff-zero { color:#FFD700; font-weight:bold; margin-left:4px; }
        .diff-negative { color:#FF0000; font-weight:bold; margin-left:4px; }
        .diff-positive { color:#00AA00; font-weight:bold; margin-left:4px; }
        .chart-container { width:100%; max-width:1000px; margin: auto; padding:10px; background:#fff; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .chart-container canvas { width:100% !important; height:400px !important; }
        @media (max-width: 600px) { .controls select, .controls input[type="text"] { font-size:13px; padding:10px; } header h1 { font-size:18px; } }
        
        /* Estilos para el texto din√°mico */
        .dynamic-text-container {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        #dynamicText {
            font-family: 'Arial Black', sans-serif;
            font-size: 2.5em;
            color: #1721BF; 
            animation: fadeInOut 3s infinite; 
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* Oculta los contenedores al inicio */
        .hidden-content {
            display: none;
        }
    @media (max-width: 768px) {
      #contenedorBloque {
        flex-direction: column;
        gap: 10px;
      }

      #contadorRacha {
        font-size: 25px !important;
        margin-top: 0 !important;
      }

      .esfera {
        width: 45px !important;
        height: 45px !important;
        font-size: 9px !important;
      }

      .esfera > div {
        font-size: 8px !important;
      }

      .esfera .iconoCumplimiento {
        width: 25px !important;
        height: 25px !important;
        top: -6px !important;
      }
    }

    /* üì± En celulares muy chicos */
    @media (max-width: 480px) {
      .esfera {
        width: 35px !important;
        height: 35px !important;
        font-size: 7px !important;
      }

      .esfera > div {
        display: none; /* üîπ Oculta textos internos para no deformar */
      }

      .esfera .iconoCumplimiento {
        width: 20px !important;
        height: 20px !important;
        top: -4px !important;
      }

      #contadorRacha {
        font-size: 22px !important;
      }
    }
        @media (max-width: 768px) {
  #popupRacha > div {
    width: 90% !important;
    padding: 25px 20px !important;
    border-radius: 20px !important;
  }

  #popupRacha img {
    width: 120px !important;
    margin-bottom: 15px !important;
  }

  #popupRacha h2 {
    font-size: 24px !important;
  }

  #popupRacha p {
    font-size: 14px !important;
  }

  #popupRacha button {
    font-size: 14px !important;
    padding: 8px 16px !important;
  }
}

@media (max-width: 480px) {
  #popupRacha > div {
    width: 95% !important;
    padding: 20px 15px !important;
  }

  #popupRacha img {
    width: 100px !important;
  }

  #popupRacha h2 {
    font-size: 20px !important;
  }

  #popupRacha p {
    font-size: 12px !important;
  }

  #popupRacha button {
    font-size: 12px !important;
    padding: 6px 12px !important;
  }
}
       @media (max-width: 768px) {
  #contenedorRachita {
    gap: 8px !important;
  }

  #tituloRachita {
    font-size: 22px !important;
  }

  #esferasRachita {
    gap: 8px !important;
    justify-content: center !important;
  }

  .esferaRachita {
    width: 45px !important;
    height: 45px !important;
    font-size: 10px !important;
  }

  /* üîπ Texto interno de las esferas */
  .esferaRachita div:nth-child(1) {
    font-size: 9px !important;
  }

  .esferaRachita div:nth-child(2) {
    font-size: 7px !important;
  }

  .esferaRachita .iconoCumplimiento {
    width: 25px !important;
    height: 25px !important;
    top: -6px !important;
  }

  #contadorRachita {
    font-size: 22px !important;
  }
}

@media (max-width: 480px) {
  #tituloRachita {
    font-size: 18px !important;
  }

  .esferaRachita {
    width: 40px !important;
    height: 40px !important;
  }

  .esferaRachita div:nth-child(1) {
    font-size: 8px !important;
  }

  .esferaRachita div:nth-child(2) {
    font-size: 6px !important;
  }

  #contadorRachita {
    font-size: 18px !important;
  }
}
        @media (max-width: 768px) {
  #bloqueGeneral {
    flex-direction: column !important;
    align-items: center !important;
    text-align: center !important;
  }

  #bloqueMensaje {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  #bloqueMensaje div {
    justify-content: center !important;
    text-align: center !important;
  }

  #bloqueMensaje img {
    width: 70px !important;
    height: 70px !important;
  }

  #bloqueMensaje div[style*="font-size:26px"] {
    font-size: 20px !important;
  }

  #bloqueMensaje div[style*="font-size:16px"] {
    font-size: 14px !important;
    margin-left: 0 !important;
  }

  #bloqueMensaje div[style*="font-size:14px"] {
    font-size: 12px !important;
    margin-left: 0 !important;
  }

  #bloqueImagenes1 img,
  #bloqueImagenes2 img {
    width: 100px !important;
    height: 100px !important;
    transform: none !important;
  }
}

@media (max-width: 480px) {
  #bloqueMensaje img {
    width: 60px !important;
    height: 60px !important;
  }

  #bloqueMensaje div[style*="font-size:26px"] {
    font-size: 18px !important;
  }

  #bloqueImagenes1 img,
  #bloqueImagenes2 img {
    width: 80px !important;
    height: 80px !important;
  }
}
  </style>
</head>
<body>

<header>
    <h1>üéÖüéÑüéÅ RACHA NAVIDE√ëA DIRECTO üéÅüéÑüéÖ</h1>
</header>

<div class="dynamic-text-container">
    <h2 id="dynamicText"></h2>
</div>

<div class="controls">
    <input id="filterMovil" class="search-box" type="text" placeholder="Buscar MOVIL (exacto)"/>
    <button id="searchButton" style="padding:8px 10px;border-radius:8px;border:1px solid #d0d7de;background:#fff;cursor:pointer;">Buscar</button>
</div>

<div id="contentContainer" class="hidden-content">
    <div class="controls" aria-hidden="false">
        <label for="filterSemana" style="font-weight:600;">Semana:</label>
        <select id="filterSemana"><option value="">Todas</option></select>

        <label id="labelFlota" style="
            font-weight:600;
            color:#007BFF;
            margin-left:10px;
        ">Flota: </label>

    </div>

    <div class="table-wrapper">
        <table id="dataTable" class="display nowrap" style="width:100%; border: 2px solid black;border-collapse: collapse; font-family: 'Poppins', sans-serif;">
            <thead><tr id="theadRow"></tr></thead>
            <tbody id="tbodyRows"></tbody>  
        </table>
    </div>
    <div id="bloqueMensaje" style="margin-top: 30px;"></div>
</div>
<script>
function normalize(s){ if(s === undefined || s === null) return ""; return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g,'').replace(/[^a-zA-Z0-9_./-]/g,'').toLowerCase(); }
function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

let chartServicios;
let dataTable;
let rawData;
let rawData1; // Variable para almacenar los datos brutos del Excel
let idxSemana, idxFlota, idxMovil, idxServicios, idxMeta, idxCump, idxDiferencia;


// Script para el texto din√°mico
document.addEventListener("DOMContentLoaded", function() {
    const dynamicTexts = ["Premios !!!", "Gana un Pavo!! üçó", "Gana una Canasta!! üéÅ"];
    let textIndex = 0;
    const dynamicTextElement = document.getElementById("dynamicText");

    function changeText() {
        dynamicTextElement.textContent = dynamicTexts[textIndex];
        textIndex = (textIndex + 1) % dynamicTexts.length;
    }

    setInterval(changeText, 3000); // Cambia el texto cada 3 segundos
    changeText(); // Inicia el texto inmediatamente
});
// POPUP
// === FUNCION POPUP RACHA ===
function mostrarEstadoRacha(esActiva) {
    $('#popupRacha').remove();
    let titulo, mensaje, subtitulo, imagen, fondo, colorBoton;

    if (esActiva === true)
    {
        titulo = 'üî• Racha activa';
        mensaje = '¬°Felicitaciones! Mantienes tu racha completando los desaf√≠os cada semana üëè'
        subtitulo = 'Participa en la *Racha Navide√±a* y gana premios. üéÅ';
        imagen = 'racha.png';
        fondo = 'linear-gradient(135deg, #ff4500, #ff8c00, #ffd700)';
        colorBoton = '#ff4500';
    }
    else if (esActiva === false)
    {
        titulo = '‚ùÑÔ∏è Racha congelada';
        mensaje = `¬°No lograste mantener tus ${numsem} semanas activas! üò¢`;
        subtitulo = '(A√∫n puedes mantener tu racha si cumples los desaf√≠os de restablecimiento)';
        imagen = 'congelada.png';
        fondo = 'linear-gradient(135deg, #0033cc, #0055ff, #66a3ff)';
        colorBoton = '#0033cc';
    }
    else if (esActiva === 'rachita')
    {
        titulo = 'üí† Pasaste a Rachita';
        mensaje = 'No pudiste cumplir con la racha, pero no te desanimes: participa en la rachita y gana premios.';
        subtitulo = 'Participa en la rachita y gana la canasta navide√±a. üéÅ';
        imagen = 'Mini-rachita.png';
        fondo = 'linear-gradient(135deg, #0033cc, #0055ff, #66a3ff)';
        colorBoton = '#0033cc';
    }

    const popupHTML = `
        <div id="popupRacha" style="
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); 
            display: flex; 
            justify-content: center; 
            align-items: center;
            z-index: 9999;
        ">
            <div style="
                ${esActiva
                    ? 'background: linear-gradient(135deg, #ff4500, #ff8c00, #ffd700);'
                    : 'background: linear-gradient(135deg, #0033cc, #0055ff, #66a3ff);'}
                border-radius: 25px;
                text-align: center;
                padding: 40px 60px;
                width: 600px;
                max-width: 90%;
                color: white;
                font-family: 'Poppins', sans-serif;
                animation: aparecer 0.4s ease-out, fuego 3s infinite linear;
                background-size: 300% 300%;
            ">
                <img src="${imagen}" style="width: 180px; height: auto; margin-bottom: 20px;">
                <h2 style="font-size: 34px; margin: 10px 0;">${titulo}</h2>
                <p style="font-size: 20px; font-weight: 500; margin-bottom: 10px;">${mensaje}</p>
                <p style="font-size: 14px; font-style: italic;">${subtitulo}</p>
                <button id="cerrarPopup" style="
                    margin-top: 25px; 
                    padding: 10px 20px; 
                    border: none; 
                    border-radius: 10px; 
                    background: white; 
                    color: ${esActiva ? '#ff4500' : '#0033cc'}; 
                    font-weight: bold; 
                    cursor: pointer;
                ">Cerrar</button>
            </div>
        </div>
    `;

    $('body').append(popupHTML);

    $('#cerrarPopup').click(function() {
        $('#popupRacha').fadeOut(300, function() { $(this).remove(); });
    });
}

function crearRachitaDebajo() {
    if ($('#contenedorRachita').length) return;

    let html = `
        <div id="contenedorRachita" style="
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:10px;
        ">
            <div id="tituloRachita" style="
                text-align:center;
                color:#ff7300;
                font-weight:bold;
                font-family:'Poppins',sans-serif;
                font-size:28px;
                margin-bottom:10px;
            ">üéÅ ¬°Rachita desbloqueada! üéÅ</div>

            <!-- Contenedor de esferas -->
            <div id="esferasRachita" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">
    `;

    for (let i = 1; i <= 10; i++) {
        html += `
            <div class="esferaRachita" id="rachita_sem${i+41}" style="
                width:60px;
                height:60px;
                background-color:#b0b0b0;
                border-radius:50%;
                display:flex;
                align-items:center;
                justify-content:center;
                flex-direction:column;
                font-family:'Poppins',sans-serif;
                font-weight:600;
                color:white;
                font-size:13px;
                box-shadow:0 2px 5px rgba(0,0,0,0.2);
                position:relative;
            ">
                <div style="font-size:11px;">Desaf√≠o ${i}</div>
                <div style="font-size:8px;">Semana ${i + 41}</div>
                <img class="iconoCumplimiento" src="" style="
                    position:absolute;
                    top:-10px;
                    width:35px;
                    height:35px;
                    display:none;
                ">
            </div>
        `;
    }

    html += `
            </div>
            <!-- Contador debajo -->
            <div id="contadorRachita" style="
                font-family:'Poppins',sans-serif;
                font-weight:700;
                font-size:30px;
                color:#ff7300;
                text-align:center;
                margin-top:10px;
            ">
                = 0 / 7
            </div>
        </div>
    `;

    $('#contenedorBloque').after(html);
}

function actualizarEsferasRachita(lista_semana,lista_diferencia) {
    const semanaInicio = lista_semana[0];
    const semanaFin = lista_semana[lista_semana.length - 1];
    let cumplida = 0;
    let j =0;
    for (let i = semanaInicio; i <= semanaFin; i++) {  
        const esfera = $(`#rachita_sem${i}`);
        const icono = esfera.find('.iconoCumplimiento');

        if (lista_diferencia[j]>=0) {
            // Semana cumplida
            esfera.css('background-color', '#FFD700');
            icono.attr('src', 'rachita.png').show();
            cumplida++;
        } else 
        {
            // Semana no cumplida
            esfera.css('background-color', 'lightblue');
            icono.attr('src', 'congelada.png').show();
        }
        j++;
    }

    // Actualizar contador al lado
    $('#contadorRachita').text(`Has cumplido ${cumplida} de los 7 desaf√≠os`);
}
// Agregar animaci√≥n CSS
const style = document.createElement('style');
style.textContent = `
@keyframes aparecer {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes fuego {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}`;
document.head.appendChild(style);

let semanaIngreso;
let numsem;

function obtenerSemanaIngreso(movil) {
    // üîπ Filtramos las filas donde la columna D (√≠ndice 3) coincide con el m√≥vil
    const filasMovil = rawData.slice(1).filter(r => String(r[3]).trim() === movil);
    if (filasMovil.length === 0) return null;

    // üîπ De esas filas, tomamos la columna B (√≠ndice 1) que contiene la semana
    const semanasMovil = filasMovil
        .map(r => parseInt(String(r[1]).replace(/\D/g, ""))) // ‚ÄúSEM.36‚Äù ‚Üí 36
        .filter(n => !isNaN(n));

    return Math.min(...semanasMovil); // üîπ Semana m√≠nima del conductor
}




$(document).ready(function(){
    fetch('data.xlsx')
        .then(r => { if(!r.ok) throw new Error('No se pudo descargar data.xlsx'); return r.arrayBuffer(); })
        .then(ab => {
            const workbook = XLSX.read(ab, {type:'array'});
            const sheetName = workbook.SheetNames.includes('data') ? 'data' : workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            rawData = XLSX.utils.sheet_to_json(sheet, {header:1, defval:""});
            if(!rawData || rawData.length<1){ alert('La hoja est√° vac√≠a o no tiene encabezados.'); return; }

            setupTableAndFilters(rawData);
        })
        .catch(err=>{ console.error(err); alert('Error cargando data.xlsx: '+err.message); });

    function setupTableAndFilters(rows) {
        if (rows[0][0] && rows[0][0].toLowerCase().includes('estado'))
        {
        rows = rows.map(r => r.slice(1)); // quita la primera columna
        }
        const headers = rows[0].map(h => h===null?"":h);
        const thead = $('#theadRow'); thead.empty();
        
        const allowedHeaders = ['M√≥vil','Semana', 'Cumplimiento', 'Servicios', 'Meta', 'Diferencia'];
        
        const headerIndexes = {};
        const displayHeaders = [];
        headers.forEach((h, i) => {
            if (allowedHeaders.includes(h)) {
                headerIndexes[normalize(h)] = i;
                displayHeaders.push(h);
                thead.append('<th>'+ (h||'') + '</th>');
            }
        });

        const tbody = $('#tbodyRows'); tbody.empty();
        for(let i=1;i<rows.length;i++){
            let tr='<tr>';
            let diferenciaVal = parseFloat(rows[i][headers.indexOf('Diferencia')]) || 0;
            displayHeaders.forEach(h => {
                const originalIndex = headers.indexOf(h);
                let cell = rows[i][originalIndex] === undefined ? '' : rows[i][originalIndex];

                if (normalize(h) === 'diferencia') {
                    let val = parseFloat(cell);
                    if (isNaN(val) || val === 0) cell = cell + ' <span class="diff-zero">‚Äî</span>';
                    else if (val < 0) cell = cell + ' <span class="diff-negative">‚ñº</span>';
                    else cell = cell + ' <span class="diff-positive">‚ñ≤</span>';
                }

                if (normalize(h) === 'cumplimiento') {
                    if (diferenciaVal < 0) {
                        cell = `<span style="color:red; font-weight:bold;">No cumple</span>`;
                    } else if (diferenciaVal >= 0){
                        cell = `<span style="color:#007bff; font-weight:bold;">Cumple</span>`;
                    } else {
                        cell = `<span style="color:gray;">‚Äî</span>`;
                    }
                    }
                tr += '<td>'+cell+'</td>';
            });
            tr+='</tr>'; 
            tbody.append(tr);
        }

        
        const displayNorm = displayHeaders.map(h => normalize(h));


        function idxDisplayOf(names) {
            for (const nm of names) {
                const target = normalize(nm);
                const idx = displayHeaders.findIndex(h => {
                    const hn = normalize(h);
                    return hn === target || hn.includes(target) || target.includes(hn);
                });
                if (idx !== -1) return idx;
            }
            return -1;
        }

idxSemana = idxDisplayOf(['Semana']);
idxMovil = idxDisplayOf(['M√≥vil', 'Movil']);
idxServicios = idxDisplayOf(['Servicios']);
idxMeta = idxDisplayOf(['Meta']);
idxCump = idxDisplayOf(['Cumplimiento']);
idxDiferencia = idxDisplayOf(['Diferencia']);
const idxFlotaExcel = headers.findIndex(h => normalize(h) === 'flota');
if ($.fn.DataTable.isDataTable('#tabla')) {
    $('#tabla').DataTable().clear().destroy();
}   
if(dataTable) dataTable.destroy();
let orderOption = [];
if (idxSemana >= 0) {
    orderOption = [[idxSemana, 'desc']];
}
$('#dataTable thead th').eq(1).text('Estado');
$('#dataTable thead th').eq(3).text('S. Realizados');
dataTable = $('#dataTable').DataTable(
    {   
        responsive:false,
        scrollX:true,
        paging: false,
        info: false,
        lengthChange: false,
        pageLength:25,
        order:[[idxSemana, 'desc']]
    });
    function uniqueValuesAt(idx)
    { 
        if(idx<0) return []; const s=new Set(); for(let i=1;i<rows.length;i++) s.add(String(rows[i][idx]??'').trim()); return Array.from(s).filter(x=>x!=='').sort((a,b)=>a.localeCompare(b+'')); }
        const semanas = uniqueValuesAt(idxSemana);
        const $fSemana=$('#filterSemana');
        $fSemana.empty().append('<option value=""> Todas </option>');
        semanas.forEach(v=>$fSemana.append(`<option value="${v}">${v}</option>`));
        function applyFilters(){
            if (idxSemana >= 0){ 
                const val = $fSemana.val(); 
                dataTable.column(idxSemana).search(val ? '^'+escapeRegex(val)+'$' : '', true, false);
            }
            dataTable.draw();
            updateChartServicios();
    }
    $('#filterSemana').on('change',applyFilters);
    /* $('#clearFilters').on('click',()=>{ $fSemana.val(''); applyFilters(); }); */
    $('#searchButton').on('click', function() {
        const mv = $('#filterMovil').val();
        if (mv) {
            $('#contentContainer').show();

            let semanasRachita = [];
            if (!$('#contenedorWrap').length) {
            $('#contentContainer').prepend(`
                <div id="contenedorWrap" style="
                    display:flex;
                    justify-content:center;
                    align-items:center;
                    gap:20px;
                    margin-bottom:20px;
                    margin-top:20px;
                    padding:6px 0;
                    border-radius:8px;
                    box-shadow:0 4px 8px rgba(0,0,0,0.2);
                    background:white;
                    font-family:'Poppins',sans-serif;
                    font-weight:700;
                    font-size:30px;
                    color:#007bff;
                    text-align:center;
                ">
                </div>
            `);
        }
        if (!$('#contenedorEsferas').length) {
            if (!$('#estilosResponsivosEsferas').length) {
        $('head').append(`
            <style id="estilosResponsivosEsferas">
                #contenedorEsferas {
                    display:flex;
                    justify-content:center;
                    flex-wrap:wrap;
                    gap:10px;
                    margin-bottom:20px;
                }

                .esfera {
                    width:60px;
                    height:60px;
                    background-color:#b0b0b0;
                    border-radius:50%;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    flex-direction:column;
                    font-family:'Poppins',sans-serif;
                    font-weight:600;
                    color:white;
                    font-size:13px;
                    box-shadow:0 2px 5px rgba(0,0,0,0.2);
                    position:relative;
                    transition: all 0.2s ease-in-out;
                }

                .esfera .iconoCumplimiento {
                    position:absolute;
                    top:-10px;
                    width:35px;
                    height:35px;
                    display:none;
                }

                /* üì± Ajuste para tablets */
                @media (max-width: 768px) {
                    .esfera {
                        width:45px;
                        height:45px;
                        font-size:10px;
                    }

                    .esfera .iconoCumplimiento {
                        width:25px;
                        height:25px;
                        top:-6px;
                    }
                }

                /* üì± Ajuste para celulares */
                @media (max-width: 480px) {
                    .esfera {
                        width:35px;
                        height:35px;
                        font-size:8px;
                    }

                    .esfera .iconoCumplimiento {
                        width:20px;
                        height:20px;
                        top:-4px;
                    }
                }
            </style>
        `);
    }
            let esferasHTML = '<div id="contenedorEsferas" >';
                for (let i = 1; i <= 15; i++) {
                    esferasHTML += `
                    <div class="esfera" id= "sem${i}" style="
                    width:60px;
                    height:60px;
                    background-color:#b0b0b0;
                    border-radius:50%;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    flex-direction: column;
                    font-family:'Poppins',sans-serif;
                    font-weight:600;
                    color:white;
                    font-size:13px;
                    box-shadow:0 2px 5px rgba(0,0,0,0.2);
                    position:relative;
                    ">
                    <div style="font-size:11px;">Desaf√≠o ${i}</div>
                    <div style="font-size:8px;font-weight:2px;">Semana ${i + 35}</div>
                    <img class="iconoCumplimiento" src="" style="
                    position:absolute;
                    top:-10px;
                    width:35px;
                    height:35px;
                    display:none;
                    ">
                    </div>
                    `;
                }
                esferasHTML += '</div>';
                
                $('#contenedorWrap').after(esferasHTML);
                $('#contenedorEsferas').after(`
                <div id="contadorRacha" style="
                font-family:'Poppins',sans-serif;
                font-weight:700;
                font-size:28px;
                color:#007bff;
                text-align:center;
                margin-top:10px;
                "> Has cumplido 0 de los 15 desaf√≠os </div>
                `);
            $('#contenedorEsferas, #contadorRacha').wrapAll(`
            <div id="contenedorBloque" style="
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:10px;
            margin-bottom:20px;
            "></div>
            `);
            }
            else 
            {
                $('.esfera').css('background-color', '#b0b0b0');
                $('[id^=icon]').hide(); 
            }
            // Filtra la tabla y actualiza
            dataTable.column(idxMovil).search('^' + escapeRegex(mv) + '$', true, false);
            dataTable.draw();
            updateChartServicios();
            const rowsData = dataTable.rows({ search: 'applied' }).data().toArray();
            if(rowsData.length > 0){
                const ultimaFila = rawData.slice(1).reverse().find(r => String(r[3]).trim() === mv);
                const flota = ultimaFila ? ultimaFila[4] : '‚Äî';
                const estado = ultimaFila ? String(ultimaFila[2]).trim() : '‚Äî';
                const semanaIngreso = obtenerSemanaIngreso(mv);

                const hoy = new Date();
                const inicioAno = new Date(hoy.getFullYear(), 0, 1);
                const dias = Math.floor((hoy - inicioAno) / (24 * 60 * 60 * 1000));
                const semanaActual = Math.ceil((dias + inicioAno.getDay() + 1) / 7);
                numsem = semanaActual - semanaIngreso;
                

                $('#labelFlota').text('Flota: ' + flota);
                let mensajeflota = '';
                let titulo = '';
                let subtitulo = '';
                let imagen = '';
                let semanasCumplidas = 0;
                let semanasTotales = 0;
                let semanasNO = 0;
                let semanaInicioRachita = 0;
                let semanaRachitaCumplidas = 0;
                /*const enRachita = numsem - semanasCumplidas >= 4; */

                for (const row of [...rowsData].reverse()) {
                    const semanaRaw = String(row[idxSemana] || '').trim();
                    let diferenciaRaw = row[idxDiferencia];
                    diferenciaRaw = String(diferenciaRaw).replace(/<[^>]*>/g, '').trim();
                    const match = semanaRaw.match(/\d+/);
                    const semanaNum = match ? parseInt(match[0]) : null;
                    const diferencia = parseFloat(diferenciaRaw);
                    const numEsfera = semanaNum ? semanaNum - 35 : null;
                    
                    if (numEsfera >= 1 && numEsfera <= 15) 
                    {
                        const esfera = $(`#sem${numEsfera}`);
                        const icono = esfera.find('.iconoCumplimiento');
                        if (diferencia >= 0)
                        {
                            esfera.css('background-color', '#ff7300');
                            icono.attr('src', 'racha.png').show();
                            semanasCumplidas++;
                        }
                        else
                        {
                            esfera.css('background-color', 'lightblue');
                            icono.attr('src', 'congelada.png').show();;
                            semanasNO++;
                            if (semanasNO === 4)
                            {
                                semanaInicioRachita = semanaNum;
                                break;
                            }
                        }

                    }
                };
                
                
                if (semanaInicioRachita < 42 & semanaInicioRachita !== null)
                    {
                        semanaInicioRachita = 42;
                    }
                numsemrachita = semanaActual - semanaInicioRachita
                let semanasrachita = [];
                let semanasdiferencia = [];
                let semanadifpositiva = [];
                if (semanaInicioRachita !== null) {
                    for (const row of [...rowsData].reverse()) {
                        const semanaRaw = String(row[idxSemana] || '').trim();
                        let diferenciaRaw = row[idxDiferencia];
                        diferenciaRaw = String(diferenciaRaw).replace(/<[^>]*>/g, '').trim();
                        const match = semanaRaw.match(/\d+/);
                        const semanaNum = match ? parseInt(match[0]) : null;
                        const diferencia = parseFloat(diferenciaRaw);
                        if (semanaNum >= semanaInicioRachita) {
                            semanasrachita.push(semanaNum);
                            semanasdiferencia.push(diferencia);
                            if (diferencia >= 0) {
                                semanadifpositiva.push(diferencia);
                            }
                        }
                    }
                }
                if (semanasCumplidas === numsem && (semanaInicioRachita === 0 || semanaInicioRachita === "" || semanaInicioRachita == null))
                {
                    titulo = '¬°La est√°s rompiendo, sigue as√≠!';
                    imagen = 'racha.png';
                    subtitulo = 'Desaf√≠os de racha:';
                    switch(flota)
                    {
                        case 'Aeropuerto':
                        case 'AEROPUERTO':
                            mensajeflota = 'Realiza 06 servicios Aeropuerto de Jueves a Domingo entre las 4pm a 11:59pm.';
                            break;
                        case 'Urbano':
                        case 'URBANO':
                            mensajeflota = 'Realiza 08 servicios de Lunes a Viernes en Ciudad entre 5am a 9am o 4pm a 9pm.';
                            break;
                        case 'Latam':
                        case 'JetSmart':
                        case 'Sky':
                        case 'LATAM':
                        case 'JETSMART':
                        case 'SKY':
                            mensajeflota = 'Realiza 20 servicios Aerol√≠neas (SKY, LATAM o JETSMART) o Destino Aeropuerto de Lunes a Domingo.';
                            break;
                        case 'Jockey Plaza':
                        case 'Bellavista':
                        case 'JOCKEY PLAZA':
                        case 'BELLAVISTA':
                            mensajeflota = 'Realiza 06 servicios de cualquiera de las siguientes condiciones:<br>- Servicios Aeropuerto de Jueves a Domingo entre las 4pm y 12am.<br>- Servicios en Ciudad de Lunes a Viernes entre las 5am y 9am o 5pm a 9pm.<br>- Servicios Aerol√≠neas (SKY, LATAM o JETSMART) o Destino Aeropuerto de Lunes a Domingo.';
                            break;
                        default:
                            mensajeflota = 'Flota desconocida, escr√≠benos para m√°s informaci√≥n al (+51 933 708 561)';
                    }
                } 
                else if (semanasCumplidas <= numsem && (semanaInicioRachita === 0 || semanaInicioRachita === "" || semanaInicioRachita == null))
                {
                    titulo = 'Necesitas restablecer tu racha';
                    imagen = 'congelada.png';
                    subtitulo = 'Desaf√≠os de restablecimiento:';
                    switch(flota)
                    {
                        case 'Aeropuerto':
                        case 'AEROPUERTO':
                            mensajeflota = 'Realiza 02 servicios Aeropuerto el viernes o domingo de 4pm a 11:59pm. <br> Una vez los cumplas, escr√≠benos para cambiar tu estado (+51 933 708 561)';
                            break;
                        case 'Urbano':
                        case 'URBANO':
                            mensajeflota = 'Realiza 02 servicios este viernes en Ciudad entre las 5am a 9am o 4pm a 9pm. <br> Una vez los cumplas, escr√≠benos para cambiar tu estado (+51 933 708 561)';
                            break;
                        case 'Latam':
                        case 'JetSmart':
                        case 'Sky':
                        case 'LATAM':
                        case 'JETSMART':
                        case 'SKY':
                            mensajeflota = 'Realiza 03 servicios Aerol√≠neas (LATAM, SKY o JETSMART) el viernes y domingo de 3pmm a 11:59pm. <br> Una vez los cumplas, escr√≠benos para cambiar tu estado (+51 933 708 561)';
                            break;
                        case 'Jockey Plaza':
                        case 'Bellavista':
                        case 'JOCKEY PLAZA':
                        case 'BELLAVISTA':
                            mensajeflota = 'Realiza 02 servicios de cualquiera de las siguientes condiciones:<br>- Servicios Aeropuerto el viernes y domingo de 4pm a 11:59pm.<br>- Servicios este viernes en Ciudad entre las 5am a 9am o 4pm a 9pm.<br>- Servicios Aerol√≠neas (LATAM, SKY o JETSMART) el viernes y domingo de 3pm a 11:59pm. <br> Una vez los cumplas, escr√≠benos para cambiar tu estado (+51 933 708 561)';
                            break;
                        default:
                            mensajeflota = 'Flota desconocida, escr√≠benos para m√°s informaci√≥n al (+51 933 708 561)';
                    }
                    
                }
                 else if (semanaInicioRachita !== 0 && numsemrachita === semanadifpositiva.length && (semanaInicioRachita !== 0 || semanaInicioRachita !== ""))
                {
                    titulo = 'Tu rachita esta que arde üî•';
                    imagen = 'Mini-rachita.png';
                    subtitulo = 'Desaf√≠os de rachita:';
                    switch(flota)
                    {
                        case 'Aeropuerto':
                        case 'AEROPUERTO':
                            mensajeflota = 'Realiza 03 servicios Aeropuerto de Jueves a Domingo entre las 4pm a 11:59pm.';
                            break;
                        case 'Urbano':
                        case 'URBANO':
                            mensajeflota = 'Realiza 06 servicios de Lunes a Viernes en Ciudad.';
                            break;
                        case 'Latam':
                        case 'JetSmart':
                        case 'Sky':
                        case 'LATAM':
                        case 'JETSMART':
                        case 'SKY':
                            mensajeflota = 'Realiza 15 servicios Aerol√≠neas (SKY, LATAM o JETSMART) o Destino Aeropuerto de Lunes a Domingo.';
                            break;
                        case 'Jockey Plaza':
                        case 'Bellavista':
                        case 'JOCKEY PLAZA':
                        case 'BELLAVISTA':
                            mensajeflota = 'Realiza 06 servicios de cualquiera de las siguientes condiciones:<br>- Servicios Aeropuerto de Jueves a Domingo entre las 4pm y 11:59am.<br>- Servicios en Ciudad de Lunes a Viernes.<br>- Servicios Aerol√≠neas (SKY, LATAM o JETSMART) o Destino Aeropuerto de Lunes a Domingo.';
                            break;
                        default:
                            mensajeflota = 'Flota desconocida, escr√≠benos para m√°s informaci√≥n al (+51 933 708 561)';
                    }
                    
                }
                else if (semanaInicioRachita !== 0 && numsemrachita > semanadifpositiva.length)
                {
                    titulo = 'Necesitas restablecer tu rachita';
                    imagen = 'congelada.png';
                    subtitulo = 'Desaf√≠os de restablecimiento de rachita:';
                    switch(flota)
                    {
                        case 'Aeropuerto':
                        case 'AEROPUERTO':
                            mensajeflota = 'Realiza 02 servicios Aeropuerto el viernes o domingo de 4am a 12pm. <br> Una vez los cumplas, escr√≠benos para cambiar tu estado (+51 933 708 561)';
                            break;
                        case 'Urbano':
                        case 'URBANO':
                            mensajeflota = 'Realiza 02 servicios este viernes en Ciudad entre las 5am a 9am o 5pm a 9pm. <br> Una vez los cumplas, escr√≠benos para cambiar tu estado (+51 933 708 561)';
                            break;
                        case 'Latam':
                        case 'JetSmart':
                        case 'Sky':
                        case 'LATAM':
                        case 'JETSMART':
                        case 'SKY':
                            mensajeflota = 'Realiza 02 servicios Aerol√≠neas (LATAM, SKY o JETSMART) el viernes y domingo de 4am a 12pm. <br> Una vez los cumplas, escr√≠benos para cambiar tu estado (+51 933 708 561)';
                            break;
                        case 'Jockey Plaza':
                        case 'Bellavista':
                        case 'JOCKEY PLAZA':
                        case 'BELLAVISTA':
                            mensajeflota = 'Realiza 02 servicios de cualquiera de las siguientes condiciones:<br>- Servicios Aeropuerto el viernes y domingo de 4am a 12pm.<br>- Servicios este viernes en Ciudad entre las 5am a 9am o 5pm a 9pm.<br>- Servicios Aerol√≠neas (LATAM, SKY o JETSMART) el viernes y domingo de 4am a 12pm. <br> Una vez los cumplas, escr√≠benos para cambiar tu estado (+51 933 708 561)';
                            break;
                        default:
                            mensajeflota = 'Flota desconocida, escr√≠benos para m√°s informaci√≥n al (+51 933 708 561)';
                    }
                    
                }
                

                
                $('#bloqueGeneral').remove();

                const footerHTML = `
                <div id="bloqueGeneral" style="display:flex; justify-content:space-between; align-items:flex-start; margin-top:30px; font-family:'Poppins', sans-serif;">
                <div id="bloqueMensaje" style="text-align:left; margin-top:10px; font-family:'Poppins', sans-serif;">
                    <div style="display:flex; justify-content:flex-start; align-items:center; gap:10px; font-size:26px; font-weight:700; color:#ff0000;">
                        <img src="${imagen}" style="width:100px; height:100px; margin-top:-5px;">
                        ${titulo}
                        </div>
                        
                        <div style="font-weight:bold; font-size:16px; margin-top:-5px;margin-left:110px;">${subtitulo}</div>
                        <div style="margin-top:5px; font-size:14px;margin-left:110px;">${mensajeflota}</div>
                </div>
                <div id="bloqueImagenes1" style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-right:10px;">
                    <img src="canasta.png" style="width:150px; height:150px;display:inline-block;transform: rotate(-30deg);">
                </div>
                <div id="bloqueImagenes2" style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-right:10px;">
                    <img src="vale.png" style="width:150px; height:150px;display:inline-block;">
                </div>
                </div>`;
                if ($('#bloqueMensaje').length)
                {
                    $('#bloqueMensaje').replaceWith(footerHTML);
                } 
                else 
                {
                    $('#contentContainer').append(footerHTML);
                }

                $('#contadorRacha').text(`Has cumplido ${semanasCumplidas} de los 15 desaf√≠os`);
                $('#mensajeRacha').remove();
                const filas = $('#dataTable tbody tr');

                if (filas.length > 0) {
                    const ultimaFila = filas.first(); 
                    const estado = ultimaFila.find('td').eq(idxCump).text().trim();
                    let mensajeHTML = "";
                    const semanasFaltantes = numsem - semanasCumplidas;
                    if (semanasCumplidas === numsem)
                    {
                        mensajeHTML = `<div id="mensajeRacha" style="
                        text-align:center;
                        color:#ff7300;
                        font-weight:bold;
                        font-family:'Poppins',sans-serif;
                        margin-top:15px;
                        font-size:30px;
                        ">üî• TU RACHA SIGUE ACTIVA üî•</div>`;
                    }
                    else if (semanasFaltantes>=4)
                    {
                        mensajeHTML = `<div id="mensajeRacha" style="
                        text-align:center;
                        color:#ff7300;
                        font-weight:bold;
                        font-family:'Poppins',sans-serif;
                        margin-top:15px;
                        font-size:30px;
                        "> Pasaste a Rachita, ¬°no te desanimes! üî•</div>`;
                    }
                    else
                    {
                        mensajeHTML = `<div id="mensajeRacha" style="
                        text-align:center;
                        color:#03A9F4;
                        font-weight:bold;
                        font-family:'Poppins',sans-serif;
                        margin-top:15px;
                        font-size:30px;
                        ">‚ùÑÔ∏è ¬°RACHA CONGELADA! ‚ùÑÔ∏è</div>`;
                    }

                    $('#mensajeRacha').remove();
                    $('#contenedorWrap').html(mensajeHTML);

                    if (semanasCumplidas === numsem)
                    {
                        $('#contenedorWrap').show();
                        $('#contenedorBloque').show();
                        mostrarEstadoRacha(true);
                        $('#contenedorRachita').remove(); 
                    } 
                    else if (semanasFaltantes >=4)
                    {
                        $('#contenedorWrap').hide(); 
                        $('#contenedorBloque').hide();
                        mostrarEstadoRacha('rachita')
                        crearRachitaDebajo();
                        actualizarEsferasRachita(semanasrachita,semanasdiferencia);
                        $('#bloqueImagenes1').show();
                        $('#bloqueImagenes2').hide();
                    }
                    else
                    {
                        $('#contenedorWrap').show();
                        $('#contenedorBloque').show();
                        mostrarEstadoRacha(false);
                        $('#contenedorRachita').remove(); 
                    }
                }
            }
            else 
            {
                alert('Por favor, ingrese un n√∫mero de m√≥vil.');
            }
        }
    });
    dataTable.on('order.dt', function()
    {
        updateChartServicios();
    })
    ;
    function updateChartServicios(){

    }
}
});
</script>
</body>
</html>
